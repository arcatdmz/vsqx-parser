function e(e,t,r){return e.find(function(e){return e.vbs===t&&e.vpc===r})}function t(e){return{vbs:parseInt(e.querySelector("vVoice>vBS").textContent),vpc:parseInt(e.querySelector("vVoice>vPC").textContent),name:e.querySelector("vVoice>vVoiceName").textContent}}function r(e){return{tick:parseInt(e.querySelector("tempo>posTick").textContent),duration:-1,bpm:parseInt(e.querySelector("tempo>bpm").textContent)}}function n(t,r){return Array.prototype.slice.call(t.querySelectorAll("vsq3>vsTrack")).map(function(t){return function(t,r){var n=parseInt(t.querySelector("vsTrack>vsTrackNo").textContent),c=t.querySelector("vsTrack>trackName").textContent,a=t.querySelector("vsTrack>comment").textContent,u=function(t,r){var n=parseInt(t.querySelector("musicalPart>posTick").textContent),c=parseInt(t.querySelector("musicalPart>playTime").textContent),a=parseInt(t.querySelector("musicalPart>singer>vBS").textContent),u=parseInt(t.querySelector("musicalPart>singer>vPC").textContent),l=e(r,a,u),i=t.querySelector("musicalPart>comment").textContent,s=Array.prototype.slice.call(t.querySelectorAll("musicalPart>note")).map(o);return{tick:n,duration:c,singer:l,comment:i,notes:s}}(t.querySelector("vsTrack>musicalPart"),r);return{no:n,name:c,comment:a,content:u}}(t,r)})}function o(e){var t=["posTick","durTick","noteNum","velocity"].map(function(t){return parseInt(e.querySelector("note>"+t).textContent)}),r=t[0],n=t[1],o=t[2],c=t[3],a=["lyric","phnms"].map(function(t){return e.querySelector("note>"+t).textContent});return{tick:r,duration:n,note:o,velocity:c,lyric:a[0],phonemes:a[1]}}function c(e){return{vbs:parseInt(e.querySelector("vVoice>bs").textContent),vpc:parseInt(e.querySelector("vVoice>pc").textContent),name:e.querySelector("vVoice>name").textContent}}function a(e){return{tick:parseInt(e.querySelector("t").textContent),duration:-1,bpm:parseInt(e.querySelector("v").textContent)}}function u(t,r){return Array.prototype.slice.call(t.querySelectorAll("vsq4>vsTrack")).map(function(t){return function(t,r){var n=parseInt(t.querySelector("vsTrack>tNo").textContent),o=t.querySelector("vsTrack>name").textContent,c=t.querySelector("vsTrack>comment").textContent,a=function(t,r){var n=parseInt(t.querySelector("vsPart>t").textContent),o=parseInt(t.querySelector("vsPart>playTime").textContent),c=parseInt(t.querySelector("vsPart>singer>bs").textContent),a=parseInt(t.querySelector("vsPart>singer>pc").textContent),u=e(r,c,a),i=t.querySelector("vsPart>comment").textContent,s=Array.prototype.slice.call(t.querySelectorAll("vsPart>note")).map(l);return{tick:n,duration:o,singer:u,comment:i,notes:s}}(t.querySelector("vsTrack>vsPart"),r);return{no:n,name:o,comment:c,content:a}}(t,r)})}function l(e){var t=["t","dur","n","v"].map(function(t){return parseInt(e.querySelector("note>"+t).textContent)}),r=t[0],n=t[1],o=t[2],c=t[3],a=["y","p"].map(function(t){return e.querySelector("note>"+t).textContent});return{tick:r,duration:n,note:o,velocity:c,lyric:a[0],phonemes:a[1]}}var i="http://www.yamaha.co.jp/vocaloid/schema/vsq3/",s="http://www.yamaha.co.jp/vocaloid/schema/vsq4/";function p(e){var o=(new DOMParser).parseFromString(e,"text/xml");if(function(e){var t=(new DOMParser).parseFromString("<","text/xml").getElementsByTagName("parsererror")[0].namespaceURI;if("http://www.w3.org/1999/xhtml"===t)return e.getElementsByTagName("parsererror").length>0;return e.getElementsByTagNameNS(t,"parsererror").length>0}(o))return{error:"XML parse error",data:null};if(o.children.length<=0||o.children[0].namespaceURI!==i&&o.children[0].namespaceURI!==s||"vsq3"!==o.children[0].tagName&&"vsq4"!==o.children[0].tagName)return{error:"Unsupported VSQX format",data:null};var l,p=o.children[0],m=p.querySelector("vsq3>vender")||p.querySelector("vsq4>vender"),v=m&&m.textContent,y=p.querySelector("vsq3>version")||p.querySelector("vsq4>version"),q=y&&y.textContent,S="vsq3"===o.children[0].tagName,f=parseInt(p.querySelector(S?"vsq3>masterTrack>resolution":"vsq4>masterTrack>resolution").textContent),x=S?function(e){var t=Array.prototype.slice.call(e.querySelectorAll("vsq3>masterTrack>tempo")).map(r);return t.forEach(function(e,r){r<t.length-1&&(e.duration=t[r+1].tick-e.tick)}),t}(p):function(e){var t=Array.prototype.slice.call(e.querySelectorAll("vsq4>masterTrack>tempo")).map(a);return t.forEach(function(e,r){r<t.length-1&&(e.duration=t[r+1].tick-e.tick)}),t}(p),k=S?(l=p,Array.prototype.slice.call(l.querySelectorAll("vsq3>vVoiceTable>vVoice")).map(t)):function(e){return Array.prototype.slice.call(e.querySelectorAll("vsq4>vVoiceTable>vVoice")).map(c)}(p);return{data:{vender:v,version:q,resolution:f,voices:k,tempos:x,tracks:S?n(p,k):u(p,k),raw:p}}}var m=function(){function e(e){this.result=e}return Object.defineProperty(e.prototype,"data",{get:function(){return this.result.data},enumerable:!0,configurable:!0}),e.prototype.tickToTime=function(e){for(var t=this.result.data,r=t.tempos,n=t.resolution,o=0,c=0,a=r;c<a.length;c++){var u=a[c],l=v(u,n);if(!(-1!==u.duration&&u.tick+u.duration<e)){o+=(e-u.tick)*l;break}o+=u.duration*l}return o},e}();function v(e,t){return 6e4/(e.bpm/100)/t}export{m as VSQXParseResultUtil,e as findVoice,p as parse,v as timePerTick};
