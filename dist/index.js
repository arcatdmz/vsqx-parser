"use strict";function findVoice(e,t,r){return e.find(function(e){return e.vbs===t&&e.vpc===r})}function parseVSQ3Voices(e){return Array.prototype.slice.call(e.querySelectorAll("vsq3>vVoiceTable>vVoice")).map(parseVoice)}function parseVoice(e){return{vbs:parseInt(e.querySelector("vVoice>vBS").textContent),vpc:parseInt(e.querySelector("vVoice>vPC").textContent),name:e.querySelector("vVoice>vVoiceName").textContent}}function parseVSQ3Tempos(e){var t=Array.prototype.slice.call(e.querySelectorAll("vsq3>masterTrack>tempo")).map(parseTempo);return t.forEach(function(e,r){r<t.length-1&&(e.duration=t[r+1].tick-e.tick)}),t}function parseTempo(e){return{tick:parseInt(e.querySelector("tempo>posTick").textContent),duration:-1,bpm:parseInt(e.querySelector("tempo>bpm").textContent)}}function parseVSQ3Tracks(e,t){return Array.prototype.slice.call(e.querySelectorAll("vsq3>vsTrack")).map(function(e){return parseTrack(e,t)})}function parseTrack(e,t){return{no:parseInt(e.querySelector("vsTrack>vsTrackNo").textContent),name:e.querySelector("vsTrack>trackName").textContent,comment:e.querySelector("vsTrack>comment").textContent,content:parseMusicalPart(e.querySelector("vsTrack>musicalPart"),t)}}function parseMusicalPart(e,t){return{tick:parseInt(e.querySelector("musicalPart>posTick").textContent),duration:parseInt(e.querySelector("musicalPart>playTime").textContent),singer:findVoice(t,parseInt(e.querySelector("musicalPart>singer>vBS").textContent),parseInt(e.querySelector("musicalPart>singer>vPC").textContent)),comment:e.querySelector("musicalPart>comment").textContent,notes:Array.prototype.slice.call(e.querySelectorAll("musicalPart>note")).map(parseNote)}}function parseNote(e){var t=["posTick","durTick","noteNum","velocity"].map(function(t){return parseInt(e.querySelector("note>"+t).textContent)}),r=t[0],n=t[1],o=t[2],a=t[3],c=["lyric","phnms"].map(function(t){return e.querySelector("note>"+t).textContent});return{tick:r,duration:n,note:o,velocity:a,lyric:c[0],phonemes:c[1]}}function parseVSQ4Voices(e){return Array.prototype.slice.call(e.querySelectorAll("vsq4>vVoiceTable>vVoice")).map(parseVoice$1)}function parseVoice$1(e){return{vbs:parseInt(e.querySelector("vVoice>bs").textContent),vpc:parseInt(e.querySelector("vVoice>pc").textContent),name:e.querySelector("vVoice>name").textContent}}function parseVSQ4Tempos(e){var t=Array.prototype.slice.call(e.querySelectorAll("vsq4>masterTrack>tempo")).map(parseTempo$1);return t.forEach(function(e,r){r<t.length-1&&(e.duration=t[r+1].tick-e.tick)}),t}function parseTempo$1(e){return{tick:parseInt(e.querySelector("t").textContent),duration:-1,bpm:parseInt(e.querySelector("v").textContent)}}function parseVSQ4Tracks(e,t){return Array.prototype.slice.call(e.querySelectorAll("vsq4>vsTrack")).map(function(e){return parseTrack$1(e,t)})}function parseTrack$1(e,t){return{no:parseInt(e.querySelector("vsTrack>tNo").textContent),name:e.querySelector("vsTrack>name").textContent,comment:e.querySelector("vsTrack>comment").textContent,content:parseMusicalPart$1(e.querySelector("vsTrack>vsPart"),t)}}function parseMusicalPart$1(e,t){return{tick:parseInt(e.querySelector("vsPart>t").textContent),duration:parseInt(e.querySelector("vsPart>playTime").textContent),singer:findVoice(t,parseInt(e.querySelector("vsPart>singer>bs").textContent),parseInt(e.querySelector("vsPart>singer>pc").textContent)),comment:e.querySelector("vsPart>comment").textContent,notes:Array.prototype.slice.call(e.querySelectorAll("vsPart>note")).map(parseNote$1)}}function parseNote$1(e){var t=["t","dur","n","v"].map(function(t){return parseInt(e.querySelector("note>"+t).textContent)}),r=t[0],n=t[1],o=t[2],a=t[3],c=["y","p"].map(function(t){return e.querySelector("note>"+t).textContent});return{tick:r,duration:n,note:o,velocity:a,lyric:c[0],phonemes:c[1]}}Object.defineProperty(exports,"__esModule",{value:!0});var vsq3NS="http://www.yamaha.co.jp/vocaloid/schema/vsq3/",vsq4NS="http://www.yamaha.co.jp/vocaloid/schema/vsq4/";function parse(e){var t=(new DOMParser).parseFromString(e,"text/xml");if(isParseError(t))return{error:"XML parse error",data:null};if(t.children.length<=0||t.children[0].namespaceURI!==vsq3NS&&t.children[0].namespaceURI!==vsq4NS||"vsq3"!==t.children[0].tagName&&"vsq4"!==t.children[0].tagName)return{error:"Unsupported VSQX format",data:null};var r=t.children[0],n=r.querySelector("vsq3>vender")||r.querySelector("vsq4>vender"),o=n&&n.textContent,a=r.querySelector("vsq3>version")||r.querySelector("vsq4>version"),c=a&&a.textContent,s="vsq3"===t.children[0].tagName,i=parseInt(r.querySelector(s?"vsq3>masterTrack>resolution":"vsq4>masterTrack>resolution").textContent),u=s?parseVSQ3Tempos(r):parseVSQ4Tempos(r),l=s?parseVSQ3Voices(r):parseVSQ4Voices(r);return{data:{vender:o,version:c,resolution:i,voices:l,tempos:u,tracks:s?parseVSQ3Tracks(r,l):parseVSQ4Tracks(r,l),raw:r}}}var VSQXParseResultUtil=function(){function e(e){this.result=e}return Object.defineProperty(e.prototype,"data",{get:function(){return this.result.data},enumerable:!0,configurable:!0}),e.prototype.tickToTime=function(e){for(var t=this.result.data,r=t.tempos,n=t.resolution,o=0,a=0,c=r;a<c.length;a++){var s=c[a],i=timePerTick(s,n);if(!(-1!==s.duration&&s.tick+s.duration<e)){o+=(e-s.tick)*i;break}o+=s.duration*i}return o},e}();function timePerTick(e,t){return 6e4/(e.bpm/100)/t}function isParseError(e){var t=(new DOMParser).parseFromString("<","text/xml").getElementsByTagName("parsererror")[0].namespaceURI;return"http://www.w3.org/1999/xhtml"===t?e.getElementsByTagName("parsererror").length>0:e.getElementsByTagNameNS(t,"parsererror").length>0}exports.VSQXParseResultUtil=VSQXParseResultUtil,exports.findVoice=findVoice,exports.parse=parse,exports.timePerTick=timePerTick;
